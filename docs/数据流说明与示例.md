# 股票分析流水线：数据流说明与示例

本文档说明 A → B → C 及故事层、迭代各步的输入输出，**每个步骤均用试跑真实数据做「字段-示例值」表格**，便于对照实现与排查。示例来源：筛选分析来自 `results/screener/2026-02-13`（002498 汉缆股份、601777 千里科技等）；两层故事来自 `results/screener/2026-02-19/single_603667`（603667 五洲新春）。

---

## 一、流程概览

- **顺序**：Step 0 目标与边界 → A 粗筛 → B 板块校准 + B 故事分析 → C AI 精筛；迭代为 D 追踪 → E 补丁建议 → 补丁池。
- **产物**：`A_candidates.json`、`B_sector_calibration.json`、`B_story_analysis.json`、`story_prompt_io/<symbol>/`、`C_ai_analysis_with_cards.json`、`S_theme_heatmap.json`、`Z_pipeline_trace_log.json`；迭代为 `D_tracking_metrics.json`、`E_patch_proposals`、`patch_pool.json`。

---

## 二、Step 0：目标与边界

- **输入**：CLI 参数与规则书硬约束。
- **输出**：是否就绪、说明文案，写入 trace log。

**字段-示例值（来自 2026-02-13 试跑 Z_pipeline_trace_log.json）**：

| 字段/路径 | 含义 | 示例值 |
|-----------|------|--------|
| step_0_goals_and_boundaries.input.min_change_pct | 最低涨幅阈值(%) | 5.0 |
| step_0_goals_and_boundaries.input.max_universe | 最大候选池数量 | 400 |
| step_0_goals_and_boundaries.input.enable_ai | 是否启用 AI 精筛 | true |
| step_0_goals_and_boundaries.input.rulebook_hard_filters.min_change_pct | 规则书涨幅下限 | 5.0 |
| step_0_goals_and_boundaries.input.rulebook_hard_filters.exclude_st | 是否排除 ST | true |
| step_0_goals_and_boundaries.input.rulebook_hard_filters.main_board_only | 是否仅主板 | true |
| step_0_goals_and_boundaries.output.ready | 是否就绪 | true |
| step_0_goals_and_boundaries.output.notes | 说明 | "粗筛看结构，先做板块定语境，再做AI个股分析，最终由人工决策" |

---

## 三、Step 1：A 粗筛

- **输入**：当日 universe（经 get_daily_universe + attach_struct_features）、硬规则、top_n。
- **输出**：通过硬规则的候选列表，写入 `A_candidates.json`。每条含行情、结构特征、`coarse_reason_tags`。

**候选条字段-示例值（002498 汉缆股份，2026-02-13）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| symbol | 6 位代码 | "002498" |
| ts_code | 带交易所后缀 | "002498.SZ" |
| name | 股票名称 | "汉缆股份" |
| market | 市场 | "主板" |
| industry | 行业 | "电气设备" |
| is_st | 是否 ST | false |
| change_pct | 当日涨跌幅(%) | 10.0813 |
| close / open / high / low | 今收/开/高/低 | 6.77, 6.28, 6.77, 6.28 |
| volume / amount | 成交量/成交额 | 2741560.81, 1829739.761 |
| trend_label | 趋势标签 | "uptrend" |
| recent_3d_change | 近 3 日涨跌幅(%) | 17.83 |
| last_close | 最近收盘价 | 6.77 |
| ma5 / ma10 / ma20 | 均线 | 6.024, 5.909, 5.761 |
| vol_ratio | 量比 | 0.947 |
| coarse_reason_tags | 粗筛理由标签 | ["breakout","trend_aligned","high_position","concept_present"] |

**另一条示例（600984 建设机械）**：`coarse_reason_tags` 含 `volume_expansion`，`vol_ratio` 为 1.392。

---

## 四、Step 2：B 板块校准

- **输入**：A 的 candidates。
- **输出**：`sector_stats`（按行业聚合）、`calibrated_analysis_list`（每条候选附带板块字段）。

**sector_stats 单条字段-示例值（电气设备，2026-02-13）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| day_strength | 该行业当日平均涨跌幅(%) | 10.037 |
| trend_3d | 三日趋势强度(%) | 16.07 |
| momentum_factor | 动量因子 | 1.15 |
| leader_symbol | 板块龙头代码 | "002498" |
| leader_change_pct | 龙头当日涨幅(%) | 10.081 |
| leader_recent_3d_change | 龙头三日涨幅(%) | 17.83 |
| leader_status | 龙头状态 | "强" |

**calibrated_analysis_list 单条新增字段-示例值（002498）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| sector | 行业 | "电气设备" |
| sector_day_strength | 同上 | 10.037 |
| sector_trend_3d | 同上 | 16.07 |
| sector_leader_symbol | 龙头代码 | "002498" |
| sector_leader_status | 龙头状态 | "强" |
| sector_multiplier | 乘数 0.85~1.15 | 1.15 |
| calibration_reason | 校准原因 | "板块走强，上调评估" |

---

## 五、Step 2：B 故事分析

### 5.1 简单模式（story_analysis_mode=simple）

- **输入**：candidates、trade_date、news_max_chars。
- **输出**：`story_by_symbol[symbol]` 含 `story_payload`、`news_text`。

**story_payload 字段-示例值（002498，2026-02-13，有新闻）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| news_count | 新闻条数(按 ### 分) | 8 |
| keyword_hits.涨停 | 关键词命中次数 | 1 |
| keyword_hits.龙虎榜 | 同上 | 4 |
| keyword_hits.题材~机构 | 其他热词 | 0 等 |
| story_heat_level | 热度等级 | "high" |
| is_mainline_candidate | 是否主线/龙头候选 | false |
| has_risk_alert | 是否有风险提示 | false |
| raw_length | 新闻文本长度 | 1800 |

**story_payload 字段-示例值（002843 泰嘉股份，新闻较少）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| news_count | 新闻条数 | 4 |
| story_heat_level | 热度等级 | "low" |
| raw_length | 新闻文本长度 | 703 |

### 5.2 两层模式（story_analysis_mode=two_layer）：603667 五洲新春示例

- **输入**：每只标的的 `input_json`（含 symbol、company_snapshot、evidence_list、**concept_list** 等）。
- **输出**：`narrative_json`、`timeline_json`、`story_card`、`story_payload`、`prompt_io`。

**input_json 主要字段-示例值（603667）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| symbol / name / industry | 代码/名称/行业 | "603667", "五洲新春", "通用设备" |
| company_snapshot.company_intro | 公司一句话介绍 | "五洲新春（603667），行业=通用设备" |
| company_snapshot.fundamentals_excerpt | 基本面摘要(截断) | "# Fundamentals for 603667 ... 行业: 通用设备\n上市时间: 20161025" |
| evidence_list[].id / title / snippet | 证据 id/标题/片段 | "E1", "## A-share News...", "..." |
| concept_list | 东财概念名列表 | ["机器人执行器","减速器","人形机器人","机器人概念"] |

**narrative_json 字段-示例值（603667）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| company_profile.company_intro | 公司介绍(100字内) | "五洲新春（603667），通用设备行业上市公司，市值约331亿..." |
| company_profile.main_business_axes | 主营方向 | ["通用设备制造","机械零部件加工"] |
| company_profile.legacy_to_new_bridge | 传统到新业务桥接 | "公司具备传统制造能力、产线与客户基础，能为向高精密传动件..." |
| company_profile.type | HARD/INFERRED | "INFERRED" |
| market_narrative[0].narrative | 市场复读主叙事 | "市场复读口径：机器人/机器人执行器与减速器板块，重点是组件龙头（行星滚柱丝杠、微型滚珠丝杠、机器人专用轴承、减速器）国产替代..." |
| market_narrative[0].type / basis | 类型与依据 | "INFERRED", "概念=机器人执行器,减速器,人形机器人,机器人概念; rank_5d=n/a" |
| evidence_hardness.hardness_grade | 证据硬度 | "Weak" |
| evidence_hardness.reason | 原因 | "公司仅在行业/概念报道中被点名（E2,E3），但近7日及募投/定期报告中缺乏关于机器人/丝杠/减速器等业务的直接披露..." |
| data_gaps | 信息缺口 | ["缺少公司机器人/丝杠业务在近7日新闻或募投中的直接披露"] |
| main_narrative_A | 主故事A(新方向/募投) | "从精密传动与轴承/精密制造切入具身智能机器人核心部件路径：市场口径为公司可利用传统精密零件加工能力，布局行星滚柱丝杠、微型滚珠丝杠与机器人专用轴承..." |
| main_narrative_B | 主故事B(传统背书) | "传统制造为新方向提供背书：公司现有通用设备制造体系、产线与客户关系，被视为向机器人/丝杠/减速器等高精密部件延伸的基础..." |

**timeline_json 字段-示例值（603667）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| timeline_1_3m[0].event | 近端催化事件 | "短期内被板块/题材资金推动导致股价波动或换手率上升（题材性资金带动）" |
| timeline_1_3m[0].type | HARD/INFERRED | "INFERRED" |
| timeline_1_3m[0].window | 时间窗口 | "1-3个月" |
| catalyst_quality.near_term_grade | 近端催化质量 | "Weak" |
| catalyst_quality.data_gaps | 催化缺口 | ["无公司层面关于机器人执行器/减速器/丝杠/轴承等业务的近期披露..."] |

**story_card 字段-示例值（603667）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| market_impression | 市场一句话印象 | "被市场以"机器人/减速器/丝杠组件"题材反复提及的通用设备龙头候选，炒作主线为利用传统精密制造能力切入机器人执行器与减速器国产化替代（机器人/丝杠龙头想象）。" |
| one_liner | 一句话总结 | "通用设备制造商，被资金流与题材贴上机器人组件（减速器/丝杠/轴承）标签，但缺乏公司层面实质披露，证据偏弱。" |
| story.market_repeated_narrative[0].text | 市场复读叙事 | "市场复读口径：机器人执行器/减速器/丝杠板块，重视组件国产替代，通用设备龙头有望被贴上机器人组件标签并获得溢价。" |
| evidence_assessment.hardness_grade | 证据硬度 | "Weak" |
| main_story_A | 主故事A 文案 | "从精密传动与轴承/精密制造→切入具身智能机器人核心部件（丝杠+机器人轴承）；定增/募资中明确写明的募投方向与产能...无则填空字符串。" |
| main_story_B | 主故事B 文案 | "传统底盘（轴承/热管理/汽车零部件）仍在，为新故事提供现金流与制造能力背书；券商研究/东财核心题材对业务结构的描述。无则填空字符串。" |

---

## 六、Step 3：C AI 个股分析

### 6.1 三种输入 + 一种输出

C 的**输入**：stock_payload、sector_payload、story_payload（JSON）、news_payload（纯文本）。**输出**：决策卡（DecisionCard 序列化）。

**stock_payload 字段-示例值（002498）**：见上文 A+B 合并后的原始字段子集，例如 symbol, name, industry, market, change_pct, close, open, high, low, volume, amount, trend_label, recent_3d_change, last_close, ma5, ma10, ma20, vol_ratio。

**sector_payload 字段-示例值（002498）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| sector | 行业 | "电气设备" |
| sector_day_strength | 当日板块强度 | 10.037 |
| sector_trend_3d | 三日趋势 | 16.07 |
| sector_multiplier | 乘数 | 1.15 |
| sector_leader_symbol | 龙头代码 | "002498" |
| sector_leader_status | 龙头状态 | "强" |
| calibration_reason | 校准原因 | "板块走强，上调评估" |

**story_payload**：见 5.1（简单模式）或两层模式下的 `story_by_symbol[symbol].story_payload`（含 one_liner、story_heat_level 等）。

### 6.2 C 输出：决策卡字段-示例值（002498，AI 模式，2026-02-13）

| 字段 | 含义 | 示例值 |
|------|------|--------|
| symbol / name / industry | 代码/名称/行业 | "002498", "汉缆股份", "电气设备" |
| conclusion_type | 结论类型 | "混合" |
| stage | 阶段 | "加速" |
| evidence_chain[0] | 证据链第 1 条 | "个股收盘6.77元，高于5/10/20日均线（ma5=6.024, ma10=5.909, ma20=5.761），近3日涨幅+17.83%，短期动能显著。" |
| evidence_chain[1] | 证据链第 2 条 | "电气设备板块走强（sector_day_strength=10.037, sector_trend_3d=16.07, sector_multiplier=1.15），且该股为板块领涨（sector_leader_status=强）..." |
| evidence_chain[2] | 证据链第 3 条 | "情绪与资金驱动特征明显：news_count=8，龙虎榜出现4次，今日换手率8.24%且主力净流入约38299万元..." |
| tradability | 可交易性 | "可短线交易：作为板块领涨股适合快进快出或日内/数日波段，但因情绪主导和高换手，需缩小仓位并预设止损以控制滑点与回撤。" |
| sustainability | 可持续性 | "可持续性偏弱到中性——板块强势提供结构性支撑，但上涨更多依赖热点与主力资金，缺乏明确持续性基本面催化..." |
| expectation_gap | 预期差 | "市场短期已大量定价延续，若后续龙虎榜资金回撤或板块动能减弱，会出现超预期回撤；当前预期偏乐观，实际基本面推进尚有不确定性。" |
| structure_position | 结构位置 | "作为板块领涨股处于本轮上涨的加速段中段，位于短期高位区域，仍有动能但筹码可能较集中..." |
| max_risk | 最大风险 | "估算3天可能最大回撤(3天MDD) ≈ 10%–15%（>8%），因此必须设置止损并优先控制风险：若入场建议首个止损位为距离当前价8%（≈6.23元）..." |
| reversal_trigger | 反转触发条件 | "出现以下任一即视为趋势转弱信号：日收盘跌破5日均线（6.024元）且伴随放量；连续多日无法放量突破或龙虎榜/主力出现大额净卖出；电气设备板块日度强度显著回落..." |
| info_gaps | 信息缺口 | ["未知主要买入/卖出营业部与机构的持仓动机与持续性...", "未明确大股东/高管是否存在近期减持或解禁安排...", "深股通/北向资金后续流向与龙虎榜具体买卖席位的连续动向..."] |

---

## 七、S 主题热度与 Z 流水线日志

**S_theme_heatmap.json 字段-示例值（2026-02-13）**：

| 字段 | 含义 | 示例值 |
|------|------|--------|
| top_sectors[0].sector | 行业名 | "汽车配件" |
| top_sectors[0].count | 该行业候选数 | 5 |
| top_sectors[0].avg_change_pct | 该行业平均涨幅(%) | 9.428 |
| story_tag_stats.risk_alert | 决策卡中含风险/回撤等关键词的数量 | 46 |
| story_tag_stats.theme_hot | 含主线/龙头/题材等数量 | 37 |
| story_tag_stats.breakout | 含突破/涨停等数量 | 38 |
| trade_date | 交易日 | "2026-02-13" |

**Z_pipeline_trace_log 步骤摘要**：step_0（见第二节）、step_1_coarse_screen（input.universe_count=47，output.candidate_count=47）、step_2_sector_calibration、step_2_story_analysis、step_3_fine_screen 的 input/output 摘要；完整见同目录 `Z_pipeline_trace_log.json` / `.md`。

---

## 八、迭代流水线：D 追踪与 E 补丁建议

**D_tracking_metrics.json 字段-示例值**（当有追踪标的时；本例 2026-02-13 为 target_count=0）：

| 字段 | 含义 | 示例值（有数据时） |
|------|------|---------------------|
| trade_date | 交易日 | "2026-02-13" |
| lookback_days | 回看天数 | 3 |
| target_count | 追踪标的数 | 0 |
| tracking_metrics[] | 追踪指标列表 | [] |
| tracking_metrics[].symbol | 标的代码 | 如 "002498" |
| tracking_metrics[].source_trade_date | 入选日 | 如 "2026-02-10" |
| tracking_metrics[].t1_return_pct / t2 / t3 | T+1/T+2/T+3 收益(%) | 如 2.5, -1.0, 0.8 |
| tracking_metrics[].mdd_3d_pct | 3 日最大回撤(%) | 如 -3.2 |
| tracking_metrics[].should_remove | 是否建议剔除 | true/false |
| summary.sample_size | 有效样本数 | 0 |

**E_patch_proposals 补丁建议单条字段**（rule_patch_suggestions / prompt_patch_suggestions）：

| 字段 | 含义 | 示例值（有数据时） |
|------|------|---------------------|
| type | 类型 | "rule" 或 "prompt" |
| title | 建议标题 | "强化回撤过滤" |
| suggestion | 建议内容 | "建议在粗筛阶段新增高波动剔除条件，并提高量能持续性门槛（例如vol_ratio下限上调）。" |
| evidence | 触发证据 | {"avg_mdd_3d_pct": -7.2, "sample_size": 10, "estimated_impact": {...}} |
| trigger_samples | 触发样本 | [{"symbol":"002498","mdd_3d_pct":-8.1,"reason_t1":"..."}] |
| confidence | 置信度 | 0.72 |
| status | 状态 | "proposed" |

本例 2026-02-13 的 E 为空的 Rule/Prompt Patch Suggestions；有数据时结构如上。

---

## 九、端到端串联表（多标的示例）

| 阶段 | 产物/数据 | 002498 汉缆股份（2026-02-13） | 603667 五洲新春（2026-02-19 两层故事） |
|------|------------|-------------------------------|----------------------------------------|
| A | 一条候选 | 电气设备，涨 10.08%，tags: breakout/trend_aligned/high_position/concept_present | 通用设备，concept_list: 机器人执行器/减速器/人形机器人/机器人概念 |
| B 板块 | sector_stats + 校准条 | 电气设备 龙头=002498，leader_status=强，multiplier=1.15 | （单票跑未再跑 B 板块） |
| B 故事(简单) | story_payload | news_count=8，story_heat_level=high，龙虎榜 4 次 | - |
| B 故事(两层) | narrative_json + story_card | - | main_narrative_A/B、market_impression、main_story_A/B 均含机器人/丝杠/组件龙头表述；data_gaps 含“缺少公司机器人/丝杠业务在近7日新闻或募投中的直接披露” |
| C 输入 | stock / sector / story / news | 见上各表 | - |
| C 输出 | 决策卡 | conclusion_type=混合，stage=加速，evidence_chain 含板块强度与龙虎榜 | - |

以上各步的**字段-示例值**均来自同一次或同目录试跑结果，可直接对照实现与排查数据流。
